<div class="staff-dashboard modern-layout">

  <!-- LEFT COLUMN -->
  <section class="staff-column staff-left modern-card">
    <div class="card-section">
      <p class="greeting">Hey, <strong><%= user ? user.username : 'Guest' %></strong></p>
      <p class="status">Status: <span class="offline">Offline</span></p>
      <button class="btn primary">Start Shift</button>
    </div>

    <div class="card-section">
      <p class="activity">0.00 / 1.5 hours (0%) this activity wave</p>
    </div>

    <div class="card-section toolbox">
      <h3>Toolbox</h3>
      <button class="btn secondary">Manage LOA</button>
      <button class="btn secondary">Actions</button>
      <button class="btn secondary">Manage Session</button>
      <button class="btn secondary">Priority Requests</button>
      <button class="btn secondary">Resources</button>
    </div>
  </section>

  <!-- CENTER COLUMN -->
  <section class="staff-column staff-center modern-card">
    <h2>Create New Log</h2>

    <form action="/staff/create-log" method="POST" id="logForm" class="modern-form">

      <label>User *</label>
      <input name="username" id="usernameInput" type="text" placeholder="Enter Roblox username" required />

      <label>Roblox Player ID</label>
      <input name="robloxId" id="robloxIdInput" type="text" placeholder="Auto-filled" />

      <label>Type</label>
      <select name="type">
        <option>Warning</option>
        <option>Active Ban Bolo</option>
        <option>Kick</option>
        <option>Ban</option>
      </select>

      <label>Reason</label>
      <textarea name="reason" id="reasonInput" placeholder="Enter reason"></textarea>

      <label>Previous Punishments</label>
      <input name="previous" id="previousInput" type="number" value="0" readonly />

      <label>Your Roblox Name</label>
      <input name="staffRoblox" type="text" placeholder="Enter your Roblox username" required />

      <input type="hidden" name="staffDiscord" value="<%= user.username %>" />

      <button type="submit" class="btn primary full">Create Log</button>
    </form>
  </section>

  <!-- RIGHT COLUMN -->
  <section class="staff-column staff-right modern-card">
    <h2>Punishment Logs</h2>

    <input type="text" class="search-bar" placeholder="Search logs..." />

    <div class="log-list">
      <% logs.forEach((log, index) => { %>

        <div class="log-card 
          <%= log.type === 'Active Ban Bolo' ? 'active-bolo' : '' %>
          <%= log.type === 'Completed Ban Bolo' ? 'completed-bolo' : '' %>"
          style="<%= log.pinned ? 'border-color:#ffcc00;background:#2a2d31;' : '' %>">

          <% if (log.pinned) { %>
            <div class="log-type" style="background:#ffcc00;color:black;">PINNED â€” AUTOMATION</div>
          <% } else { %>
            <div class="log-header">
              <span class="log-type"><%= log.type %></span>
            </div>
          <% } %>

          <div class="log-body">
            <p><strong>User:</strong> <%= log.username %></p>
            <p><strong>Roblox ID:</strong> <%= log.robloxId %></p>
            <p><strong>Reason:</strong> <%= log.reason %></p>
            <p><strong>Previous Punishments:</strong> <%= log.previous %></p>
            <p class="timestamp"><%= log.created %></p>

            <% if (log.completed) { %>
              <p class="completed-info">
                Completed by <strong><%= log.completedBy %></strong> at <%= log.completedAt %>
              </p>
            <% } %>
          </div>

          <div class="log-footer">
            <% if (log.moderator === 'Automation') { %>
              <span class="log-avatar-circle">ðŸ¤–</span>
            <% } else if (log.moderatorId && log.moderatorAvatar) { %>
              <img
                class="log-avatar"
                src="https://cdn.discordapp.com/avatars/<%= log.moderatorId %>/<%= log.moderatorAvatar %>.png"
                onerror="this.style.display='none';"
              />
            <% } %>

            <div class="log-footer-text">
              <span>
                Submitted by <strong><%= log.moderator %></strong>
                (Roblox: <%= log.staffRoblox || 'Unknown' %>)
              </span>
            </div>
          </div>

          <!-- DELETE BUTTON -->
          <form action="/staff/delete-log/<%= index %>" method="POST" style="margin-top:10px;">
            <button class="btn secondary" style="background:#d83c3e;color:white;">Delete</button>
          </form>

          <!-- COMPLETE BUTTON (only for active BOLOs) -->
          <% if (log.type === "Active Ban Bolo") { %>
            <form action="/staff/complete-log/<%= index %>" method="POST" style="margin-top:10px;">
              <button class="btn secondary" style="background:#4da6ff;color:white;">Mark Completed</button>
            </form>
          <% } %>

        </div>

      <% }) %>
    </div>
  </section>

</div>

<script>
  // Auto-fill Roblox ID using Roblox API
  document.getElementById('usernameInput').addEventListener('blur', async () => {
    const username = document.getElementById('usernameInput').value;
    if (!username) return;

    try {
      const res = await fetch('https://users.roblox.com/v1/usernames/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ usernames: [username], excludeBannedUsers: false })
      });

      const data = await res.json();
      const match = data.data?.find(u => u.name.toLowerCase() === username.toLowerCase());

      document.getElementById('robloxIdInput').value = match?.id || '';
    } catch {
      document.getElementById('robloxIdInput').value = '';
    }
  });

  // Auto-fill previous punishments from logs
  document.getElementById('usernameInput').addEventListener('blur', () => {
    const username = document.getElementById('usernameInput').value.toLowerCase();
    const logs = <%- JSON.stringify(logs) %>;
    const count = logs.filter(log => log.username && log.username.toLowerCase() === username).length;
    document.getElementById('previousInput').value = count;
  });
</script>

<script>
  // Search filter for logs
  const searchInput = document.querySelector('.search-bar');
  const logCards = document.querySelectorAll('.log-card');

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();

    logCards.forEach(card => {
      const text = card.innerText.toLowerCase();
      card.style.display = text.includes(query) ? 'block' : 'none';
    });
  });
</script>